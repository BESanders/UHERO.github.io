<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
	    <title>New Visualization</title>
		<script type="text/javascript" src="js/dat.gui.min.js"></script>
	    <script type="text/javascript" src="js/d3.v3.min.js"></script>
		<script type="text/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript" src="js/jquery.svg.js"></script>
		<script src="js/d3.slider.js"></script>
		<link rel="stylesheet" href="js/d3.slider.css" type="text/css">
		<style>
		.pcp, .lifecycle { float:left; width: 100px; height:139px;}
		.pcp h5 { margin:0 0 20px 0; padding:0;}
		h3.section_header {clear:both;}
		h3.year{position:absolute; left:650px; top:2px}
		div#headers {position:relative;}
		</style>
	</head>
  	<body>
<h3 class="country_header">united states of america</h3>
<div id="slider"></div>
<h3 class="year">2018</h3>
<div style="position:relative; top:-30px; width: 950px">
	<div id="headers">
		<h3 style="margin-left: 75px">Per Captia Profile</h3>
		<h3 style="position:absolute; left: 428px; top:-16px">Population</h3>
		<h3 style="position:absolute; left: 728px; top:-16px">Lifecycle</h3>
	</div>
	<svg id="pcp_selected"></svg>
	<svg id="population_distributions"></svg>
	<svg id="lifecycle_selected"></svg>
	<div id="files_loaded"></div>
	<div id="link_states" style="padding-top:15px"></div>
	<!-- <br/>
	<a href = "javascript:;" id="pcp">PCP</a>
	<a href = "javascript:;" id="lifecycle">Lifecycle</a>
	<a href = "javascript:;" id="population">Population</a> -->

	<h3 class="section_header">Per Capita Profiles</h3>
	<div id="per_capita_profiles"></div>
</div>
<!-- <h3 class="section_header">Lifecycles</h3>
<div id="lifecycles"></div> -->

</body>
<script>
var chart_height = 200
var margin_top = 10
var pop_distributions_width = 300
var margin_left = 10

var pcp_height = 100
var pcp_width = 100

var year = 2018
var countries_loaded = {}
var population_projections = {}
var countries = [
"austria.csv", 
"brazil.csv", 
"costa_rica.csv", 
"finland.csv", 
"germany.csv", 
"hungary.csv", 
"india.csv", 
"indonesia.csv", 
"japan.csv", 
"kenya.csv",
"mexico.csv",
"nigeria.csv",
"philippines.csv",
"republic_of_korea.csv",
"slovenia.csv",
"spain.csv",
"sweden.csv",
"thailand.csv",
"united_states_of_america.csv"]
var country_names = [];
var pop_csv = [];
var lifecycle_storage;
var date_column_header = "Reference date (as of 1 July)";
var country_column_header = "Major area, region, country or area *";
var country_selected = "united states of america";
var current_state = "pcp";
var zero_data_array = [];

var y_lifecycle = d3.scale.linear().range([pcp_height,0]).domain([0,200000000])
var y_pcp = d3.scale.linear().range([pcp_height,0]).domain([0,50000])
var x_pcp = d3.scale.linear().domain([0,100]).range([0, pcp_width])
var y_pop = d3.scale.linear().range([margin_top+chart_height, margin_top])
var y_pop_small = d3.scale.linear().range([pcp_height,0])
var x = d3.scale.linear().domain([0,100]).range([margin_left,margin_left+pop_distributions_width])
var y_pcp_selected = d3.scale.linear().range([margin_top+chart_height, margin_top])
var y_lifecycle_selected = d3.scale.linear().range([margin_top+chart_height, margin_top])

var svg = d3.select("#population_distributions")
	.attr("height", chart_height+margin_top)
	.attr("width", pop_distributions_width+margin_left)

var pcp_selected_svg = d3.select("#pcp_selected")
	.attr("height", chart_height+margin_top)
	.attr("width", pop_distributions_width+margin_left)
	
var lifecycle_selected_svg = d3.select("#lifecycle_selected")
	.attr("height", chart_height+margin_top)
	.attr("width", pop_distributions_width+margin_left)
	
function replace_underscore_with_space(item){
	return item.replace(/ /g, "_");
}

function intify(int_string) {
  var num = parseInt(int_string.replace(',','').replace(/\s/g,''),10)
  return isNaN(num) ? 0 : num
}

function pcp_vals(pcp_data){
	return pcp_data.map(function(d) { return intify(d.value) })
}

function pop_vals(pop_data) { 
	return pop_data.map(function(d) { return intify(d) })
}

function change_year_title(new_year){
	d3.select("h3.year").text(new_year)
}

function update_year(new_year) {
	year = new_year
	create_population_distributions()
	update_life_cycles()
	update_selected_lifecycle()
	d3.select("path."+country_selected.replace(/ /g, ".")).attr("fill", "red")
	update_pop_divs()
	change_year_title(new_year);
}

var pop_path = d3.svg.area()
	.x(function(d, i) { return x(i) })
	.y(function(d) { return y_pop(intify(d)) })
	.y0(y_pop(0))
	
var pop_path_small = d3.svg.area()
	.x(function(d, i) { return x_pcp(i) })
	.y(function(d) { return y_pop_small(intify(d))})
	.y0(y_pop_small(0))
	
var pcp_path = d3.svg.area()
	.x(function(d) { return x_pcp(intify(d.key)) })
	.y(function(d) { return y_pcp(intify(d.value)) })
	.y0(y_pcp(0))

var lifecycle_path = d3.svg.area()
	.x(function(d) { return x_pcp(intify(d.key)) })
	.y(function(d) { return y_lifecycle(d.value) })
	.y0(y_lifecycle(0))

var pcp_selected_path = d3.svg.area()
	.x(function(d){ return x(intify(d.key)) })
	.y(function(d){ return y_pcp_selected(intify(d.value)) })
	.y0(y_pcp_selected(0))

var lifecycle_selected_path = d3.svg.area()
	.x(function(d){ return x(intify(d.key)) })
	.y(function(d){ return y_lifecycle_selected(d.value) })
	.y0(y_lifecycle_selected(0))
	
function create_age_and_value_pair_array(data) {
	return  d3.entries(data)
		.filter(function(d) { return !isNaN(parseInt(d.key,10)) })
		.sort(function(a,b) {return d3.ascending(intify(a.key), intify(b.key))})
}

function shorten_population_array(data){
	var array = d3.entries(data)
		.filter(function(d) { return !isNaN(parseInt(d.key,10)) })
		.sort(function(a,b) {return d3.ascending(intify(a.key), intify(b.key))})
		
	array = array.map(function(d){
		return d.value;
	})
	
	var value = 0;
	array.forEach(function(d, i){
		if(i >= 90){
			value += parseInt(d);
			array[90] = value.toString();
		}
	})
	
	array = array.filter(function(d, i){ return i <= 90;})
	
	return array;
	
}

function create_pcp_times_population_and_age_array(country, data, given_year) {
	var pop_array = []
	var age_array = create_age_and_value_pair_array(data)
	var matches = population_projections[given_year]
		.filter(function(d) { return d[country_column_header].toLowerCase() === country.replace(/_/g, " ") })
	if (matches.length > 0)
		pop_array = create_age_and_value_pair_array(matches[0])
	else
		console.log("NOTHING for " + country)
	var pop_lookup = d3.nest().key(function(d) {return d.key}).rollup(function(leaves) {return leaves[0].value}).map(pop_array)
	return age_array.map(function(d) { 
		var val = (pop_lookup[d.key] === undefined) ? 0 : intify(d.value) * intify(pop_lookup[d.key]);
		return {key : d.key, value: val} 
	})
	
}

function create_empty_array(data){
	zero_data_array = d3.entries(data)
						.map(function(d){
							return {key: d.key, value: 0}
					  })
}

function update_pop_divs(){
	if(current_state === "population"){
		d3.selectAll("div.pcp")
			.selectAll("svg")
			.selectAll("path."+current_state+".active")
			.data(function(d){
				return [
					{key: "population", data: lifecycle_storage[year][d]["population"]},
					{key: "population", data: lifecycle_storage[year][d]["population"]}
				]
			})
			.attr("d", function(d){ return pop_path_small(d.data)})
	}
}

// function update_life_cycles() {
// 	d3.selectAll(".lifecycle svg").selectAll("path")
// 		.data(function(d) {   
// 			return [
// 				{key: "consumption", data: lifecycle_storage[year][d]["consumption"]},
// 				{key: "production", data: lifecycle_storage[year][d]["production"]}
// 			]
// 		})
// 		.attr("d", function(d) { return lifecycle_path(d.data) })
// }

function update_life_cycles(){
	if(current_state === "lifecycle"){
		d3.selectAll("div.pcp")
			.selectAll("svg")
			.selectAll("path.active")
			.data(function(d) {   
				return [
					{key: "consumption", data: lifecycle_storage[year][d]["consumption"]},
					{key: "production", data: lifecycle_storage[year][d]["production"]}
				]
			})
			.attr("d", function(d) { return lifecycle_path(d.data) })
	}
}

function update_selected_lifecycle(){
	d3.select("#lifecycle_selected").selectAll("path")
		.data(function(){
			return [
				{key: "consumption", data: lifecycle_storage[year][country_selected]["consumption"]},
				{key: "production", data: lifecycle_storage[year][country_selected]["production"]}
			]
		})
		.attr("d", function(d) { return lifecycle_selected_path(d.data) })
}

function highlight_country_population(pop, d){
	pop.attr("fill", "red")
	y_pop.domain([0, d3.max(pop_vals(lifecycle_storage[year][d]["population"]))])
	svg.selectAll("path")
			.transition()
			.attr("d", function(d) { 
				if(d !== "taiwan"){
					return pop_path(lifecycle_storage[year][d]["population"]) 
				}
			})

	d3.select("#files_loaded").text(d)
}

function create_population_distributions() {
	svg.selectAll("path").remove()
	var pop_dists = svg.selectAll("path")
		.data(country_names)
				
	pop_dists
		.enter()
		.append("path")
		.attr("stroke", "none")
		.attr("fill", "blue")
		.attr("fill-opacity", .2)
		.attr("class", function(d) { return d; })
		.on("mouseover", function(d) { 
			var pop = d3.select(this) 
			highlight_country_population(pop, d)
		})
		.on("mouseout", function(d) {
			var pop = d3.select(this)
			pop.attr("fill", "blue")
			pop = d3.select("path."+country_selected.replace(/ /g, "."))
			highlight_country_population(pop, country_selected)
		})
		
	pop_dists
		.attr("d", function(d) { 
			return pop_path(lifecycle_storage[year][d]["population"]) 
		})
				
}

function create_pcp_distributions(d){
	pcp_selected_svg.selectAll("path").remove();
	var pcp = countries_loaded[replace_underscore_with_space(d)]
	var consumption_data = create_age_and_value_pair_array(pcp[1]);
	var production_data = create_age_and_value_pair_array(pcp[10]);
	
	var max_consum = d3.max(pcp_vals(consumption_data))
	var max_prod = d3.max(pcp_vals(production_data))
	var max_pcp = d3.max([max_consum, max_prod])
	
	y_pcp_selected.domain([0, max_pcp])
	
	var pcp_dists = pcp_selected_svg.selectAll("path")
		.data(function(){ 			
				return [
					{key: "consumption", data: consumption_data },
					{key: "production", data: production_data }
				]
			})
	
	pcp_dists
		.enter()
		.append("path")
		.attr("stroke", "none")
		.attr("fill", "red")
		.attr("fill-opacity", .2)
		.attr("country", d)
	
	pcp_dists
		.attr("d", function(d){
			return pcp_selected_path(d.data)
		})
}

function create_lifecycle_distributions(d){
	lifecycle_selected_svg.selectAll("path").remove();
	var max_consum = d3.max(lifecycle_storage[year][d]["consumption"], function(d){ return d.value; })
	var max_prod = d3.max(lifecycle_storage[year][d]["production"], function(d){ return d.value; }) 
	var max_lifecycle = d3.max([max_consum, max_prod])
	
	y_lifecycle_selected.domain([0, max_lifecycle])
	
	var lifecycle_dists = lifecycle_selected_svg.selectAll("path")
		.data(function(){
			return [
				{key: "consumption", data: lifecycle_storage[year][d]["consumption"] },
				{key: "production", data: lifecycle_storage[year][d]["production"] }
			]
		})
	
	lifecycle_dists
		.enter()
		.append("path")
		.attr("stroke", "none")
		.attr("fill", "green")
		.attr("fill-opacity", .2)
		.attr("country", d)
	
	lifecycle_dists
		.attr("d", function(d){
			return lifecycle_selected_path(d.data)
		})
}

function add_country(name, data) {
	if(name !== "taiwan"){
		countries_loaded[name] = data;	
		country_names.push(name.replace(/_/g, " "))
	}
}

function year_key(d){
	return d[date_column_header]
}

function country_key(d){
	return d[country_column_header].toLowerCase()
}

function return_pcp_and_population_arrays(leaves){
	var data = leaves[0]
	var country = replace_underscore_with_space(data[country_column_header].toLowerCase())
	var year = data[date_column_header]
	var pcp = countries_loaded[country]; 
	return pcp !== undefined ? {
		consumption: create_pcp_times_population_and_age_array(country, pcp[1], year), 
		production: create_pcp_times_population_and_age_array(country, pcp[10], year), 
		population: shorten_population_array(data)//create_age_and_value_pair_array(data)
		} : {population: shorten_population_array(data)};//create_age_and_value_pair_array(data)};
}

function create_lifecycle_storage(){
	lifecycle_storage = d3.nest()
			.key(year_key)
			.key(country_key)
			.rollup(return_pcp_and_population_arrays)
			.map(pop_csv)
}

function sort_country_names_by_population(){
	country_names.sort(function(a,b){return d3.descending(d3.sum(pop_vals(lifecycle_storage[year][a]["population"])), d3.sum(pop_vals(lifecycle_storage[year][b]["population"])) )})
}

function change_country_name(country){
	d3.select("h3.country_header").text(country)
}

function initialize_page() {
	create_lifecycle_storage();
	sort_country_names_by_population();
	var max_pop = d3.max(pop_vals(lifecycle_storage[year][country_names[0]]["population"]))
	y_pop.domain([0,max_pop]);	
	y_pop_small.domain([0, max_pop]);
	create_population_distributions()
	create_pcp_distributions("united states of america");
	create_lifecycle_distributions("united states of america");
	var pop = d3.select("path.united.states.of.america")
	highlight_country_population(pop, "united states of america")
	create_empty_array(lifecycle_storage[year][country_names[0]]["production"])
	
	var pcp_divs = d3.select("#per_capita_profiles")
		.selectAll("div.pcp")
		.data(country_names)
		.enter()
		.append("div")
		.attr("class", "pcp")
	
	var pcp_svgs = pcp_divs
		.append("svg")
		.attr("height", pcp_height)
		.attr("width", pcp_width)
		.on("click", function(d){
			d3.select("path."+country_selected.replace(/ /g, ".")).attr("fill","blue")
			country_selected = d;
			create_pcp_distributions(d);
			create_lifecycle_distributions(d);
			var pop = d3.select("path."+d.replace(/ /g, "."))
			highlight_country_population(pop, d)
			change_country_name(d)
		})
	
	pcp_divs.append("h5").text(function(d) { return d})
	
	pcp_svgs.selectAll("path")
		.data(function(d) { 
			var pcp = countries_loaded[replace_underscore_with_space(d)]
			return [
				{key: "consumption", data: create_age_and_value_pair_array(pcp[1]), state: "pcp active"},
				{key: "production", data: create_age_and_value_pair_array(pcp[10]), state: "pcp active"},
				{key: "population", data: zero_data_array, state: "population dormant" },
				{key: "population", data: zero_data_array, state: "population dormant"}
			]
		})
		.enter()
		.append("path")
		.attr("class", function(d){
			return d.state;
		})
		.attr("fill", "red")
		.attr("fill-opacity", .1)
		.attr("d", function(d) { 
			if(d.state === "pcp active"){
				return pcp_path(d.data)
			}else if(d.state === "population dormant"){
				return lifecycle_path(d.data)
			}
		 })
		
	// var lifecycle_divs = d3.select("#lifecycles")
	// 	.selectAll("div.lifecycle")
	// 	.data(country_names)
	// 	.enter()
	// 	.append("div")
	// 	.attr("class", "lifecycle")
	// var lifecycle_svgs = lifecycle_divs
	// 	.append("svg")
	// 	.attr("height", pcp_height)
	// 	.attr("width", pcp_width)
	// 
	// lifecycle_divs.append("h5").text(function(d) { return d})
	// 
	// lifecycle_svgs.selectAll("path")
	// 	.data(function(d) { 
	// 		return [
	// 		{key: "consumption", data: lifecycle_storage[year][d]["consumption"]},
	// 		{key: "production", data: lifecycle_storage[year][d]["production"]}
	// 		]
	// 	})
	// 	.enter()
	// 	.append("path")
	// 	.attr("fill", "green")
	// 	.attr("fill-opacity", .1)
	// 	.attr("d", function(d) { return lifecycle_path(d.data) })
	// 

}


function switch_paths(target_state){
	d3.selectAll("div.pcp")
		.selectAll("svg")
		.selectAll("path."+current_state+".active")
		.data(function(){
			if(current_state === "pcp"){
				return [
					{key: "consumption", data: zero_data_array},
					{key: "production", data: zero_data_array}
				]
			}else if(current_state === "population"){
				return [
					{key: "population", data: zero_data_array},
					{key: "population", data: zero_data_array}
				]
			}
		})
		.attr("class", function(){
			return current_state + " dormant";
		})
		.transition()
		.duration(1000)
		.attr("d", function(d){ return lifecycle_path(d.data)})
	
	d3.selectAll("div.pcp")
		.selectAll("svg")
		.selectAll("path."+target_state+".dormant")
		.data(function(d){
			if(target_state === "pcp"){
				var pcp = countries_loaded[replace_underscore_with_space(d)]
				return [
					{key: "consumption", data: create_age_and_value_pair_array(pcp[1])},
					{key: "production", data: create_age_and_value_pair_array(pcp[10])}
				]
			}else if(target_state === "population"){
				return [
					{key: "population", data: lifecycle_storage[year][d]["population"]},
					{key: "population", data: lifecycle_storage[year][d]["population"]}
				]
			}
		})
		.attr("class", function(){
			return target_state + " active";
		})
		.transition()
		.duration(1000)
		.attr("d", function(d) { 
			if(target_state === "pcp"){
				return pcp_path(d.data)
			}else if(target_state === "population"){
				return pop_path_small(d.data)
			}
		})

}

function switch_current_paths(target_state){
	d3.selectAll("div.pcp")
		.selectAll("svg")
		.selectAll("path.active")
		.data(function(d){
			var pcp = countries_loaded[replace_underscore_with_space(d)]
			if(target_state === "pcp"){
				return [
					{key: "consumption", data: create_age_and_value_pair_array(pcp[1])},
					{key: "production", data: create_age_and_value_pair_array(pcp[10])}
				]
			}else if(target_state === "population"){
				return [
					{key: "population", data: lifecycle_storage[year][d]["population"]},
					{key: "population", data: lifecycle_storage[year][d]["population"]}
				]
			}else if(target_state === "lifecycle"){
				return [
					{key: "consumption", data: lifecycle_storage[year][d]["consumption"]},
					{key: "production", data: lifecycle_storage[year][d]["production"]}
				]
			}
		})
		.transition()
		.duration(1000)
		.attr("d", function(d){
			if(target_state === "pcp"){
				return pcp_path(d.data)
			}else if(target_state === "population"){
				return pop_path_small(d.data)
			}else if(target_state === "lifecycle"){
				return lifecycle_path(d.data)
			}
		})
	
	if(target_state === "pcp"){
		d3.selectAll("div.pcp")
			.selectAll("svg")
			.selectAll("path.dormant")
			.attr("class", function(){
				return "population dormant"
			})
			
		d3.selectAll("div.pcp")
			.selectAll("svg")
			.selectAll("path.active")
			.attr('class', function(){
				return "pcp active"
			})
	}else if(target_state === "population"){
		d3.selectAll("div.pcp")
			.selectAll("svg")
			.selectAll("path.dormant")
			.attr("class", function(){
				return "pcp dormant"
			})
			
		d3.selectAll("div.pcp")
			.selectAll("svg")
			.selectAll("path.active")
			.attr('class', function(){
				return "population active"
			})
	}
}

function redraw_small_multiples(d){
	var target_state = d;
	if(target_state === "lifecycle" || current_state === "lifecycle"){
		switch_current_paths(d);
	}else{
		switch_paths(d);
	}
	current_state = d;
	target_state = undefined
	d3.select(".section_header").text(function(){ 
		if(d === "population"){
			return "Population";
		}else if(d === "pcp"){
			return "Per Capita Profiles";
		}else if(d === "lifecycle"){
			return "Lifecycles";
		}
	})
}

d3.csv("nta_countries_pop_projections.csv", function(data) {
	pop_csv = data;
	population_projections = d3.nest().key(function(d) { return d[date_column_header] }).map(data)
	
	countries.forEach(function(country) {
		d3.csv(country, function(data) {
			var name = country.split(".")[0]
			add_country(name, data)
			if (d3.keys(countries_loaded).length === countries.length)
				initialize_page();
		})
	})	
	
})

d3.select("#slider")
	.style("width", pop_distributions_width+"px")
	.attr("class", "slider")
		.call(
			d3.slider()
				.min(2011)
				.max(2100)
				.value(2018)
				.step(1)
				.on("slide", function(evt, value) {
					update_year(value)				
				})
			)
			
d3.select("#link_states").selectAll("a")
	.data(["pcp", "lifecycle", "population"])
	.enter()
	.append("a")
	.attr("href", "javascript:;")
	.html(function(d){ return d})
	.style({"padding-right": "20px"})
	.on("click", redraw_small_multiples)
	
</script>
</html>

